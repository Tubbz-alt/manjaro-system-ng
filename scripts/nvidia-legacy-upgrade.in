#!/bin/sh

source @prefix@/share/libalpm/util-manjaro.sh

set_pkg_ver $1

# ver_condition=20160307-1

# nvidia legacy changes (sept-oct 2014 - kernels 3.10-3.17)
if $(is_installed "nvidia-utils"); then
	if ! $(is_installed 'mhwd-nvidia-340xx'); then
		msg "Updating mhwd database"
		install_pkg mhwd-db
	fi
	local vid=$(mhwd | grep " video-nvidia ")
	local drv=$(mhwd-gpu | grep nvidia)
	local nv=$(pacman -Qq | grep nvidia | grep -v mhwd | grep -v toolkit)
	if [[ -z "$vid" && -n "$drv" ]]; then
		msg "Maintaining video driver at version nvidia-340xx"
		remove_pkg $nv
		install_pkg $($nv | sed 's|nvidia|nvidia-340xx|g')
		rm -r /var/lib/mhwd/local/pci/video-nvidia/
		cp -a /var/lib/mhwd/db/pci/graphic_drivers/nvidia-340xx/ /var/lib/mhwd/local/pci/
	fi
fi
